// =================================================================
// GOOGLE APPS SCRIPT - API CHO CLASSROOM MANAGER
// Chuc nang: Upload anh len Drive, Luu Sheets, Cham bai AI
// =================================================================

// !!! THAY DOI GIA TRI NAY !!!
const SHEET_ID = "1eVtXbRUEwoYYPy4aM9ZHoRX1z35ZR4dNo2Vt_35UQ7E"; // ID cua Google Sheet

// Cau hinh
const CONFIG = {
  GEMINI_API_URL: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent',
  DRIVE_FOLDERS: {
    ASSIGNMENTS: 'Classroom_Assignments',
    SOLUTIONS: 'Classroom_Solutions',
    SUBMISSIONS: 'Classroom_Submissions'
  },
  MAX_IMAGE_SIZE: 10 * 1024 * 1024 // 10MB
};

// Global
let ss, SHEETS;

// =================================================================
// WEB APP ENTRY POINTS
// =================================================================

function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({
    status: 'ok',
    message: 'Classroom Manager API v1.0'
  })).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    let data;
    
    // Handle form data (URLSearchParams) - for CORS compatibility
    if (e.parameter && e.parameter.data) {
      data = JSON.parse(e.parameter.data);
    }
    // Handle JSON body (backup)
    else if (e.postData && e.postData.contents) {
      data = JSON.parse(e.postData.contents);
    } 
    else {
      return createResponse({ success: false, error: 'No data received' });
    }
    
    const action = data.action;
    
    let result;
    
    switch (action) {
      // Assignment APIs
      case 'createAssignment':
        result = createAssignment(data);
        break;
      case 'getAssignments':
        result = getAssignments(data.classId);
        break;
      case 'deleteAssignment':
        result = deleteAssignment(data.assignmentId);
        break;
        
      // Submission APIs  
      case 'submitAssignment':
        result = submitAssignment(data);
        break;
      case 'getSubmissions':
        result = getSubmissions(data.assignmentId);
        break;
      case 'getStudentSubmission':
        result = getStudentSubmission(data.assignmentId, data.studentId);
        break;
        
      // Grading APIs
      case 'gradeSubmission':
        result = gradeSubmission(data.submissionId);
        break;
      case 'gradeAllSubmissions':
        result = gradeAllSubmissions(data.assignmentId);
        break;
        
      // API Key APIs
      case 'getApiKeys':
        result = getApiKeys();
        break;
      case 'addApiKey':
        result = addApiKey(data.name, data.key);
        break;
      case 'removeApiKey':
        result = removeApiKey(data.keyId);
        break;
      case 'toggleApiKey':
        result = toggleApiKey(data.keyId);
        break;
        
      default:
        result = { success: false, error: 'Unknown action: ' + action };
    }
    
    return createResponse(result);
      
  } catch (error) {
    console.error('doPost error:', error);
    return createResponse({
      success: false,
      error: error.toString()
    });
  }
}

// Helper function to create CORS-friendly response
function createResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

// =================================================================
// INITIALIZATION
// =================================================================

function ensureSheetsReady() {
  if (SHEETS) return;
  
  ss = SpreadsheetApp.openById(SHEET_ID);
  
  SHEETS = {
    ASSIGNMENTS: getOrCreateSheet('Assignments', [
      'AssignmentID', 'ClassID', 'Title', 'Description', 'ProblemText',
      'AttachmentFileId', 'AttachmentFileName', 'SolutionImageIds',
      'DueDate', 'CreatedAt', 'TeacherID'
    ]),
    SUBMISSIONS: getOrCreateSheet('Submissions', [
      'SubmissionID', 'AssignmentID', 'StudentID', 'StudentName', 'StudentEmail',
      'ImageIds', 'TextAnswer', 'Score', 'Feedback', 'IsGraded',
      'SubmittedAt', 'GradedAt'
    ]),
    API_KEYS: getOrCreateSheet('ApiKeys', [
      'KeyID', 'Name', 'Key', 'IsActive', 'UsageCount', 'LastUsed', 'CreatedAt'
    ])
  };
}

function getOrCreateSheet(name, headers) {
  let sheet = ss.getSheetByName(name);
  if (!sheet) {
    sheet = ss.insertSheet(name);
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold');
    sheet.setFrozenRows(1);
  }
  return sheet;
}

// =================================================================
// DRIVE FUNCTIONS
// =================================================================

function getOrCreateFolder(folderName) {
  const folders = DriveApp.getFoldersByName(folderName);
  if (folders.hasNext()) {
    return folders.next();
  }
  const folder = DriveApp.createFolder(folderName);
  folder.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  return folder;
}

function uploadImageToDrive(base64Data, fileName, folderType) {
  try {
    if (!base64Data || !base64Data.trim()) {
      return { success: false, error: 'Empty image data' };
    }
    
    // Remove data URL prefix if present
    let cleanBase64 = base64Data;
    if (base64Data.includes(',')) {
      cleanBase64 = base64Data.split(',')[1];
    }
    
    const blob = Utilities.newBlob(
      Utilities.base64Decode(cleanBase64),
      'image/jpeg',
      fileName
    );
    
    if (blob.getBytes().length > CONFIG.MAX_IMAGE_SIZE) {
      return { success: false, error: 'Image too large (max 10MB)' };
    }
    
    const folder = getOrCreateFolder(CONFIG.DRIVE_FOLDERS[folderType]);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    return {
      success: true,
      fileId: file.getId(),
      viewUrl: 'https://drive.google.com/uc?id=' + file.getId(),
      thumbnailUrl: 'https://drive.google.com/thumbnail?id=' + file.getId() + '&sz=w400'
    };
  } catch (e) {
    console.error('Upload error:', e);
    return { success: false, error: e.toString() };
  }
}

function uploadMultipleImages(base64Images, baseFileName, folderType) {
  if (!Array.isArray(base64Images) || base64Images.length === 0) {
    return { success: true, fileIds: [] };
  }
  
  const fileIds = [];
  const errors = [];
  
  for (let i = 0; i < base64Images.length; i++) {
    const fileName = baseFileName + '_' + (i + 1) + '_' + Date.now() + '.jpg';
    const result = uploadImageToDrive(base64Images[i], fileName, folderType);
    
    if (result.success) {
      fileIds.push(result.fileId);
    } else {
      errors.push('Image ' + (i + 1) + ': ' + result.error);
    }
  }
  
  return {
    success: fileIds.length > 0,
    fileIds: fileIds,
    errors: errors.length > 0 ? errors : undefined
  };
}

function getImageBase64FromDrive(fileId) {
  try {
    const file = DriveApp.getFileById(fileId);
    const blob = file.getBlob();
    return {
      success: true,
      base64: Utilities.base64Encode(blob.getBytes()),
      mimeType: blob.getContentType()
    };
  } catch (e) {
    return { success: false, error: e.toString() };
  }
}

function deleteFileFromDrive(fileId) {
  try {
    DriveApp.getFileById(fileId).setTrashed(true);
    return { success: true };
  } catch (e) {
    return { success: false, error: e.toString() };
  }
}

// =================================================================
// ASSIGNMENT FUNCTIONS
// =================================================================

function createAssignment(data) {
  try {
    ensureSheetsReady();
    
    const assignmentId = 'ASSIGN_' + Date.now();
    const now = new Date().toISOString();
    
    // Upload attachment if provided
    let attachmentFileId = '';
    let attachmentFileName = '';
    
    if (data.attachmentBase64 && data.attachmentFileName) {
      const uploadResult = uploadImageToDrive(
        data.attachmentBase64,
        data.attachmentFileName,
        'ASSIGNMENTS'
      );
      if (uploadResult.success) {
        attachmentFileId = uploadResult.fileId;
        attachmentFileName = data.attachmentFileName;
      }
    }
    
    // Upload solution images
    let solutionImageIds = [];
    if (data.solutionImages && data.solutionImages.length > 0) {
      const uploadResult = uploadMultipleImages(
        data.solutionImages,
        'solution_' + assignmentId,
        'SOLUTIONS'
      );
      if (uploadResult.success) {
        solutionImageIds = uploadResult.fileIds;
      }
    }
    
    // Save to sheet
    SHEETS.ASSIGNMENTS.appendRow([
      assignmentId,
      data.classId || '',
      data.title || '',
      data.description || '',
      data.problemText || '',
      attachmentFileId,
      attachmentFileName,
      JSON.stringify(solutionImageIds),
      data.dueDate || '',
      now,
      data.teacherId || ''
    ]);
    
    return {
      success: true,
      assignmentId: assignmentId,
      solutionImagesCount: solutionImageIds.length,
      attachmentFileId: attachmentFileId
    };
    
  } catch (e) {
    console.error('createAssignment error:', e);
    return { success: false, error: e.toString() };
  }
}

function getAssignments(classId) {
  try {
    ensureSheetsReady();
    
    const data = SHEETS.ASSIGNMENTS.getDataRange().getValues();
    const headers = data[0];
    const assignments = [];
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const rowClassId = row[headers.indexOf('ClassID')];
      
      if (!classId || rowClassId === classId) {
        const solutionIds = row[headers.indexOf('SolutionImageIds')];
        let solutionImageIds = [];
        try {
          solutionImageIds = JSON.parse(solutionIds || '[]');
        } catch (e) {}
        
        const attachFileId = row[headers.indexOf('AttachmentFileId')];
        
        assignments.push({
          id: row[headers.indexOf('AssignmentID')],
          classId: rowClassId,
          title: row[headers.indexOf('Title')],
          description: row[headers.indexOf('Description')],
          problemText: row[headers.indexOf('ProblemText')],
          attachmentFileId: attachFileId,
          attachmentFileName: row[headers.indexOf('AttachmentFileName')],
          attachmentUrl: attachFileId ? 'https://drive.google.com/uc?id=' + attachFileId : null,
          solutionImageIds: solutionImageIds,
          solutionImagesCount: solutionImageIds.length,
          dueDate: row[headers.indexOf('DueDate')],
          createdAt: row[headers.indexOf('CreatedAt')],
          teacherId: row[headers.indexOf('TeacherID')]
        });
      }
    }
    
    return { success: true, assignments: assignments };
    
  } catch (e) {
    console.error('getAssignments error:', e);
    return { success: false, error: e.toString() };
  }
}

function deleteAssignment(assignmentId) {
  try {
    ensureSheetsReady();
    
    const data = SHEETS.ASSIGNMENTS.getDataRange().getValues();
    const headers = data[0];
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][headers.indexOf('AssignmentID')] === assignmentId) {
        // Delete files from Drive
        const attachmentId = data[i][headers.indexOf('AttachmentFileId')];
        if (attachmentId) deleteFileFromDrive(attachmentId);
        
        const solutionIds = data[i][headers.indexOf('SolutionImageIds')];
        try {
          const ids = JSON.parse(solutionIds || '[]');
          ids.forEach(function(id) { deleteFileFromDrive(id); });
        } catch (e) {}
        
        // Delete row
        SHEETS.ASSIGNMENTS.deleteRow(i + 1);
        
        // Also delete submissions
        deleteSubmissionsByAssignment(assignmentId);
        
        return { success: true };
      }
    }
    
    return { success: false, error: 'Assignment not found' };
    
  } catch (e) {
    console.error('deleteAssignment error:', e);
    return { success: false, error: e.toString() };
  }
}

// =================================================================
// SUBMISSION FUNCTIONS
// =================================================================

function submitAssignment(data) {
  try {
    ensureSheetsReady();
    
    // Check if already submitted
    const existing = getStudentSubmission(data.assignmentId, data.studentId);
    if (existing.success && existing.submission) {
      return { success: false, error: 'Ban da nop bai nay roi' };
    }
    
    const submissionId = 'SUB_' + Date.now();
    const now = new Date().toISOString();
    
    // Upload images
    let imageIds = [];
    if (data.images && data.images.length > 0) {
      const uploadResult = uploadMultipleImages(
        data.images,
        'submission_' + data.studentId + '_' + data.assignmentId,
        'SUBMISSIONS'
      );
      if (uploadResult.success) {
        imageIds = uploadResult.fileIds;
      } else {
        return { success: false, error: 'Loi upload anh: ' + (uploadResult.errors ? uploadResult.errors.join(', ') : 'Unknown') };
      }
    }
    
    if (imageIds.length === 0 && (!data.textAnswer || !data.textAnswer.trim())) {
      return { success: false, error: 'Can it nhat 1 anh hoac cau tra loi' };
    }
    
    // Save to sheet
    SHEETS.SUBMISSIONS.appendRow([
      submissionId,
      data.assignmentId,
      data.studentId,
      data.studentName || '',
      data.studentEmail || '',
      JSON.stringify(imageIds),
      data.textAnswer || '',
      '', // Score
      '', // Feedback
      'false', // IsGraded
      now,
      '' // GradedAt
    ]);
    
    return {
      success: true,
      submissionId: submissionId,
      imagesCount: imageIds.length
    };
    
  } catch (e) {
    console.error('submitAssignment error:', e);
    return { success: false, error: e.toString() };
  }
}

function getSubmissions(assignmentId) {
  try {
    ensureSheetsReady();
    
    const data = SHEETS.SUBMISSIONS.getDataRange().getValues();
    const headers = data[0];
    const submissions = [];
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[headers.indexOf('AssignmentID')] === assignmentId) {
        let imageIds = [];
        try {
          imageIds = JSON.parse(row[headers.indexOf('ImageIds')] || '[]');
        } catch (e) {}
        
        submissions.push({
          id: row[headers.indexOf('SubmissionID')],
          assignmentId: row[headers.indexOf('AssignmentID')],
          studentId: row[headers.indexOf('StudentID')],
          studentName: row[headers.indexOf('StudentName')],
          studentEmail: row[headers.indexOf('StudentEmail')],
          imageIds: imageIds,
          imagesCount: imageIds.length,
          textAnswer: row[headers.indexOf('TextAnswer')],
          score: row[headers.indexOf('Score')],
          feedback: row[headers.indexOf('Feedback')],
          isGraded: row[headers.indexOf('IsGraded')] === 'true',
          submittedAt: row[headers.indexOf('SubmittedAt')],
          gradedAt: row[headers.indexOf('GradedAt')]
        });
      }
    }
    
    return { success: true, submissions: submissions };
    
  } catch (e) {
    console.error('getSubmissions error:', e);
    return { success: false, error: e.toString() };
  }
}

function getStudentSubmission(assignmentId, studentId) {
  try {
    ensureSheetsReady();
    
    const data = SHEETS.SUBMISSIONS.getDataRange().getValues();
    const headers = data[0];
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[headers.indexOf('AssignmentID')] === assignmentId &&
          row[headers.indexOf('StudentID')] === studentId) {
        
        let imageIds = [];
        try {
          imageIds = JSON.parse(row[headers.indexOf('ImageIds')] || '[]');
        } catch (e) {}
        
        return {
          success: true,
          submission: {
            id: row[headers.indexOf('SubmissionID')],
            assignmentId: row[headers.indexOf('AssignmentID')],
            studentId: row[headers.indexOf('StudentID')],
            studentName: row[headers.indexOf('StudentName')],
            imageIds: imageIds,
            imagesCount: imageIds.length,
            textAnswer: row[headers.indexOf('TextAnswer')],
            score: row[headers.indexOf('Score')],
            feedback: row[headers.indexOf('Feedback')],
            isGraded: row[headers.indexOf('IsGraded')] === 'true',
            submittedAt: row[headers.indexOf('SubmittedAt')],
            gradedAt: row[headers.indexOf('GradedAt')]
          }
        };
      }
    }
    
    return { success: true, submission: null };
    
  } catch (e) {
    console.error('getStudentSubmission error:', e);
    return { success: false, error: e.toString() };
  }
}

function deleteSubmissionsByAssignment(assignmentId) {
  try {
    ensureSheetsReady();
    
    const data = SHEETS.SUBMISSIONS.getDataRange().getValues();
    const headers = data[0];
    
    // Find rows to delete (from bottom to top)
    const rowsToDelete = [];
    for (let i = 1; i < data.length; i++) {
      if (data[i][headers.indexOf('AssignmentID')] === assignmentId) {
        rowsToDelete.push(i + 1);
        
        // Delete images
        const imageIds = data[i][headers.indexOf('ImageIds')];
        try {
          const ids = JSON.parse(imageIds || '[]');
          ids.forEach(function(id) { deleteFileFromDrive(id); });
        } catch (e) {}
      }
    }
    
    // Delete from bottom to top
    rowsToDelete.reverse().forEach(function(row) {
      SHEETS.SUBMISSIONS.deleteRow(row);
    });
    
    return { success: true, deletedCount: rowsToDelete.length };
    
  } catch (e) {
    return { success: false, error: e.toString() };
  }
}

// =================================================================
// GRADING FUNCTIONS
// =================================================================

function gradeSubmission(submissionId) {
  try {
    ensureSheetsReady();
    
    // Find submission
    const subData = SHEETS.SUBMISSIONS.getDataRange().getValues();
    const subHeaders = subData[0];
    let submission = null;
    let submissionRow = -1;
    
    for (let i = 1; i < subData.length; i++) {
      if (subData[i][subHeaders.indexOf('SubmissionID')] === submissionId) {
        submission = {
          assignmentId: subData[i][subHeaders.indexOf('AssignmentID')],
          imageIds: JSON.parse(subData[i][subHeaders.indexOf('ImageIds')] || '[]'),
          textAnswer: subData[i][subHeaders.indexOf('TextAnswer')]
        };
        submissionRow = i + 1;
        break;
      }
    }
    
    if (!submission) {
      return { success: false, error: 'Khong tim thay bai nop' };
    }
    
    // Find assignment
    const assignData = SHEETS.ASSIGNMENTS.getDataRange().getValues();
    const assignHeaders = assignData[0];
    let assignment = null;
    
    for (let i = 1; i < assignData.length; i++) {
      if (assignData[i][assignHeaders.indexOf('AssignmentID')] === submission.assignmentId) {
        assignment = {
          problemText: assignData[i][assignHeaders.indexOf('ProblemText')],
          solutionImageIds: JSON.parse(assignData[i][assignHeaders.indexOf('SolutionImageIds')] || '[]')
        };
        break;
      }
    }
    
    if (!assignment) {
      return { success: false, error: 'Khong tim thay bai tap' };
    }
    
    if (assignment.solutionImageIds.length === 0) {
      return { success: false, error: 'Bai tap chua co dap an de cham' };
    }
    
    // OCR teacher solutions
    console.log('OCR dap an giao vien...');
    let teacherSolution = '';
    for (let j = 0; j < assignment.solutionImageIds.length; j++) {
      const fileId = assignment.solutionImageIds[j];
      const imgData = getImageBase64FromDrive(fileId);
      if (imgData.success) {
        const ocrResult = callGeminiOCR(imgData.base64, 'teacher_solution');
        if (ocrResult.success) {
          teacherSolution += ocrResult.text + '\n\n';
        }
      }
    }
    
    if (!teacherSolution.trim()) {
      return { success: false, error: 'Khong the doc dap an giao vien' };
    }
    
    // OCR student submission
    console.log('OCR bai lam hoc sinh...');
    let studentAnswer = submission.textAnswer || '';
    for (let k = 0; k < submission.imageIds.length; k++) {
      const fileId = submission.imageIds[k];
      const imgData = getImageBase64FromDrive(fileId);
      if (imgData.success) {
        const ocrResult = callGeminiOCR(imgData.base64, 'student_work');
        if (ocrResult.success) {
          studentAnswer += '\n\n[Bai lam tu anh]\n' + ocrResult.text;
        }
      }
    }
    
    if (!studentAnswer.trim()) {
      return { success: false, error: 'Khong the doc bai lam hoc sinh' };
    }
    
    // Grade
    console.log('Dang cham bai...');
    const gradingResult = callGeminiGrading(
      assignment.problemText,
      teacherSolution,
      studentAnswer
    );
    
    if (!gradingResult.success) {
      return { success: false, error: 'Loi cham bai: ' + gradingResult.error };
    }
    
    // Update submission
    const scoreCol = subHeaders.indexOf('Score') + 1;
    const feedbackCol = subHeaders.indexOf('Feedback') + 1;
    const isGradedCol = subHeaders.indexOf('IsGraded') + 1;
    const gradedAtCol = subHeaders.indexOf('GradedAt') + 1;
    
    SHEETS.SUBMISSIONS.getRange(submissionRow, scoreCol).setValue(gradingResult.score);
    SHEETS.SUBMISSIONS.getRange(submissionRow, feedbackCol).setValue(gradingResult.feedback);
    SHEETS.SUBMISSIONS.getRange(submissionRow, isGradedCol).setValue('true');
    SHEETS.SUBMISSIONS.getRange(submissionRow, gradedAtCol).setValue(new Date().toISOString());
    
    return {
      success: true,
      score: gradingResult.score,
      feedback: gradingResult.feedback
    };
    
  } catch (e) {
    console.error('gradeSubmission error:', e);
    return { success: false, error: e.toString() };
  }
}

function gradeAllSubmissions(assignmentId) {
  try {
    const submissions = getSubmissions(assignmentId);
    if (!submissions.success) {
      return submissions;
    }
    
    const ungraded = submissions.submissions.filter(function(s) { return !s.isGraded; });
    if (ungraded.length === 0) {
      return { success: true, message: 'Khong co bai nao can cham', gradedCount: 0 };
    }
    
    const results = [];
    let gradedCount = 0;
    let errorCount = 0;
    
    for (let i = 0; i < ungraded.length; i++) {
      const sub = ungraded[i];
      console.log('Cham bai ' + sub.id + '...');
      const result = gradeSubmission(sub.id);
      
      if (result.success) {
        gradedCount++;
        results.push({ submissionId: sub.id, success: true, score: result.score });
      } else {
        errorCount++;
        results.push({ submissionId: sub.id, success: false, error: result.error });
      }
      
      // Delay to avoid rate limiting
      Utilities.sleep(3000);
    }
    
    return {
      success: true,
      gradedCount: gradedCount,
      errorCount: errorCount,
      results: results
    };
    
  } catch (e) {
    console.error('gradeAllSubmissions error:', e);
    return { success: false, error: e.toString() };
  }
}

// =================================================================
// GEMINI AI FUNCTIONS
// =================================================================

function getActiveApiKey() {
  try {
    ensureSheetsReady();
    
    const data = SHEETS.API_KEYS.getDataRange().getValues();
    const headers = data[0];
    
    const activeKeys = [];
    for (let i = 1; i < data.length; i++) {
      if (data[i][headers.indexOf('IsActive')] === 'true') {
        activeKeys.push({
          row: i + 1,
          key: data[i][headers.indexOf('Key')],
          usageCount: parseInt(data[i][headers.indexOf('UsageCount')] || '0')
        });
      }
    }
    
    if (activeKeys.length === 0) return null;
    
    // Round-robin by usage
    activeKeys.sort(function(a, b) { return a.usageCount - b.usageCount; });
    const selected = activeKeys[0];
    
    // Update usage
    const usageCol = headers.indexOf('UsageCount') + 1;
    const lastUsedCol = headers.indexOf('LastUsed') + 1;
    SHEETS.API_KEYS.getRange(selected.row, usageCol).setValue(selected.usageCount + 1);
    SHEETS.API_KEYS.getRange(selected.row, lastUsedCol).setValue(new Date().toISOString());
    
    return selected.key;
    
  } catch (e) {
    console.error('getActiveApiKey error:', e);
    return null;
  }
}

function callGeminiOCR(base64Image, type) {
  try {
    const apiKey = getActiveApiKey();
    if (!apiKey) {
      return { success: false, error: 'Khong co API key' };
    }
    
    let prompt = '';
    if (type === 'teacher_solution') {
      prompt = 'Ban la chuyen gia OCR toan hoc. Hay doc va go lai CHINH XAC noi dung dap an trong hinh anh. ' +
               'Giu nguyen format, thu tu cac buoc giai. Su dung LaTeX cho cong thuc toan neu co. ' +
               'Chi tra ve noi dung OCR, khong giai thich them.';
    } else {
      prompt = 'Ban la chuyen gia OCR toan hoc. Hay doc va go lai CHINH XAC bai lam hoc sinh trong hinh anh. ' +
               'Giu nguyen thu tu cac buoc lam. Ghi lai ca nhung cho lam sai, lam thieu. ' +
               'Su dung LaTeX cho cong thuc toan neu co. Chi tra ve noi dung OCR, khong nhan xet.';
    }
    
    const payload = {
      contents: [{
        parts: [
          { text: prompt },
          { inline_data: { mime_type: 'image/jpeg', data: base64Image } }
        ]
      }],
      generationConfig: { temperature: 0.2, maxOutputTokens: 4096 }
    };
    
    const response = UrlFetchApp.fetch(CONFIG.GEMINI_API_URL + '?key=' + apiKey, {
      method: 'POST',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    });
    
    const json = JSON.parse(response.getContentText());
    
    if (json.error) {
      return { success: false, error: json.error.message };
    }
    
    const text = json.candidates && json.candidates[0] && json.candidates[0].content && 
                 json.candidates[0].content.parts && json.candidates[0].content.parts[0] &&
                 json.candidates[0].content.parts[0].text;
    if (!text) {
      return { success: false, error: 'Khong nhan duoc phan hoi' };
    }
    
    return { success: true, text: text };
    
  } catch (e) {
    console.error('callGeminiOCR error:', e);
    return { success: false, error: e.toString() };
  }
}

function callGeminiGrading(problemText, teacherSolution, studentAnswer) {
  try {
    const apiKey = getActiveApiKey();
    if (!apiKey) {
      return { success: false, error: 'Khong co API key' };
    }
    
    const prompt = 
      'Ban la GIAO VIEN TOAN HOC CHUYEN NGHIEP voi 20 nam kinh nghiem cham bai.\n' +
      'Nhiem vu: CHAM BAI TOAN bang cach so sanh chi tiet bai lam hoc sinh voi dap an chuan.\n\n' +
      '[DE BAI]\n' + (problemText || 'Khong co de bai cu the') + '\n\n' +
      '[DAP AN CHUAN CUA GIAO VIEN]\n' + teacherSolution + '\n\n' +
      '[BAI LAM CUA HOC SINH]\n' + studentAnswer + '\n\n' +
      'TIEU CHI CHAM BAI:\n' +
      '1. PHUONG PHAP GIAI (4 diem): Hoc sinh co chon dung phuong phap khong?\n' +
      '2. CAC BUOC THUC HIEN (4 diem): Tung buoc co chinh xac khong?\n' +
      '3. KET QUA CUOI CUNG (2 diem): Dap an co dung khong?\n\n' +
      'QUY TAC CHAM:\n' +
      '- Neu phuong phap dung nhung co loi tinh toan nho: tru 0.5-1 diem\n' +
      '- Neu thieu buoc quan trong: tru 1-2 diem\n' +
      '- Neu lam dung mot phan: cho diem tuong ung\n' +
      '- Cach lam sang tao nhung dung: diem toi da\n' +
      '- Thang diem: 0-10 (co the dung so thap phan 0.25, 0.5, 0.75)\n\n' +
      'HAY TRA VE DUNG DINH DANG SAU:\n\n' +
      'PHAN TICH CHI TIET:\n[Phan tich tung buoc cua hoc sinh]\n\n' +
      'DIEM THANH PHAN:\n- Phuong phap giai: X/4 diem\n- Cac buoc thuc hien: Y/4 diem\n- Ket qua cuoi cung: Z/2 diem\n\n' +
      'DIEM TONG: A/10\n\n' +
      'NHAN XET CHI TIET:\n[Nhan xet cu the ve tung phan lam dung/sai]\n\n' +
      'GOI Y CAI THIEN:\n[Huong dan hoc sinh khac phuc loi sai]';
    
    const payload = {
      contents: [{ parts: [{ text: prompt }] }],
      generationConfig: { temperature: 0.3, maxOutputTokens: 8192 }
    };
    
    const response = UrlFetchApp.fetch(CONFIG.GEMINI_API_URL + '?key=' + apiKey, {
      method: 'POST',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    });
    
    const json = JSON.parse(response.getContentText());
    
    if (json.error) {
      return { success: false, error: json.error.message };
    }
    
    const text = json.candidates && json.candidates[0] && json.candidates[0].content && 
                 json.candidates[0].content.parts && json.candidates[0].content.parts[0] &&
                 json.candidates[0].content.parts[0].text;
    if (!text) {
      return { success: false, error: 'Khong nhan duoc phan hoi' };
    }
    
    // Extract score
    const score = extractScore(text);
    
    return {
      success: true,
      score: score,
      feedback: text
    };
    
  } catch (e) {
    console.error('callGeminiGrading error:', e);
    return { success: false, error: e.toString() };
  }
}

function extractScore(text) {
  // Try to find score patterns
  let match = text.match(/DIEM\s*TONG[:\s]*(\d+(?:[.,]\d+)?)\s*[\/]?\s*10/i);
  if (match) {
    let score = parseFloat(match[1].replace(',', '.'));
    if (score < 0) score = 0;
    if (score > 10) score = 10;
    return Math.round(score * 4) / 4;
  }
  
  match = text.match(/(\d+(?:[.,]\d+)?)\s*\/\s*10/);
  if (match) {
    let score = parseFloat(match[1].replace(',', '.'));
    if (score < 0) score = 0;
    if (score > 10) score = 10;
    return Math.round(score * 4) / 4;
  }
  
  match = text.match(/(\d+(?:[.,]\d+)?)\s*diem/i);
  if (match) {
    let score = parseFloat(match[1].replace(',', '.'));
    if (score < 0) score = 0;
    if (score > 10) score = 10;
    return Math.round(score * 4) / 4;
  }
  
  return 0;
}

// =================================================================
// API KEY MANAGEMENT
// =================================================================

function getApiKeys() {
  try {
    ensureSheetsReady();
    
    const data = SHEETS.API_KEYS.getDataRange().getValues();
    const headers = data[0];
    const keys = [];
    
    for (let i = 1; i < data.length; i++) {
      keys.push({
        id: data[i][headers.indexOf('KeyID')],
        name: data[i][headers.indexOf('Name')],
        key: data[i][headers.indexOf('Key')],
        isActive: data[i][headers.indexOf('IsActive')] === 'true',
        usageCount: parseInt(data[i][headers.indexOf('UsageCount')] || '0'),
        lastUsed: data[i][headers.indexOf('LastUsed')],
        createdAt: data[i][headers.indexOf('CreatedAt')]
      });
    }
    
    return { success: true, keys: keys };
    
  } catch (e) {
    return { success: false, error: e.toString() };
  }
}

function addApiKey(name, key) {
  try {
    ensureSheetsReady();
    
    const keyId = 'KEY_' + Date.now();
    const now = new Date().toISOString();
    
    SHEETS.API_KEYS.appendRow([
      keyId, name, key, 'true', '0', '', now
    ]);
    
    return { success: true, keyId: keyId };
    
  } catch (e) {
    return { success: false, error: e.toString() };
  }
}

function removeApiKey(keyId) {
  try {
    ensureSheetsReady();
    
    const data = SHEETS.API_KEYS.getDataRange().getValues();
    const headers = data[0];
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][headers.indexOf('KeyID')] === keyId) {
        SHEETS.API_KEYS.deleteRow(i + 1);
        return { success: true };
      }
    }
    
    return { success: false, error: 'Key not found' };
    
  } catch (e) {
    return { success: false, error: e.toString() };
  }
}

function toggleApiKey(keyId) {
  try {
    ensureSheetsReady();
    
    const data = SHEETS.API_KEYS.getDataRange().getValues();
    const headers = data[0];
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][headers.indexOf('KeyID')] === keyId) {
        const currentStatus = data[i][headers.indexOf('IsActive')] === 'true';
        const col = headers.indexOf('IsActive') + 1;
        SHEETS.API_KEYS.getRange(i + 1, col).setValue(currentStatus ? 'false' : 'true');
        return { success: true, isActive: !currentStatus };
      }
    }
    
    return { success: false, error: 'Key not found' };
    
  } catch (e) {
    return { success: false, error: e.toString() };
  }
}

// =================================================================
// TEST & SETUP FUNCTION
// =================================================================

function testSetup() {
  console.log('=== BAT DAU SETUP ===');
  
  // 1. Tao cac Sheets
  console.log('1. Dang tao Sheets...');
  ensureSheetsReady();
  console.log('   - Sheet Assignments: OK');
  console.log('   - Sheet Submissions: OK');
  console.log('   - Sheet ApiKeys: OK');
  
  // 2. Tao cac Folders trong Drive
  console.log('2. Dang tao Folders trong Drive...');
  const folderNames = Object.values(CONFIG.DRIVE_FOLDERS);
  for (let i = 0; i < folderNames.length; i++) {
    const folder = getOrCreateFolder(folderNames[i]);
    console.log('   - Folder ' + folderNames[i] + ': OK (ID: ' + folder.getId() + ')');
  }
  
  console.log('=== SETUP HOAN TAT ===');
  console.log('');
  console.log('Buoc tiep theo:');
  console.log('1. Deploy > New deployment > Web app');
  console.log('2. Execute as: Me');
  console.log('3. Who has access: Anyone');
  console.log('4. Copy URL va dan vao React app');
  
  return { success: true, message: 'Setup completed!' };
}

// Test API connection
function testApi() {
  return {
    success: true,
    message: 'API is working!',
    timestamp: new Date().toISOString(),
    sheetId: SHEET_ID
  };
}
